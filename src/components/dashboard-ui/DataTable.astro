---
/**
 * DataTable - Table component with sorting and pagination
 *
 * @description
 * A comprehensive table component with client-side sorting, pagination,
 * search/filter functionality, and row actions. Includes responsive
 * horizontal scrolling for mobile devices.
 *
 * Features:
 * - Sortable columns (client-side)
 * - Pagination controls
 * - Search/filter input
 * - Row action buttons
 * - Empty state support
 * - Responsive horizontal scroll
 *
 * @example
 * ```astro
 * <DataTable
 *   columns={[
 *     { key: 'name', label: 'Name', sortable: true },
 *     { key: 'email', label: 'Email', sortable: true },
 *     { key: 'role', label: 'Role', sortable: false }
 *   ]}
 *   data={users}
 *   actions={[
 *     { label: 'Edit', onClick: 'handleEdit', variant: 'primary' },
 *     { label: 'Delete', onClick: 'handleDelete', variant: 'danger' }
 *   ]}
 *   emptyMessage="No users found"
 * />
 * ```
 */

import EmptyState from './EmptyState.astro';

interface Column {
  key: string;
  label: string;
  sortable?: boolean;
}

interface Action {
  label: string;
  onClick: string; // JavaScript function name
  variant?: 'primary' | 'secondary' | 'danger';
}

interface Props {
  columns: Column[];
  data: Array<Record<string, any>>;
  actions?: Action[];
  emptyMessage?: string;
  searchable?: boolean;
  itemsPerPage?: number;
}

const {
  columns,
  data,
  actions = [],
  emptyMessage = 'No data available',
  searchable = true,
  itemsPerPage = 10,
} = Astro.props;

// Generate unique ID for this table instance
const tableId = `data-table-${Math.random().toString(36).substring(2, 11)}`;
---

<div class="data-table-container">
  {
    searchable && (
      <div class="data-table-search">
        <input
          type="text"
          id={`${tableId}-search`}
          class="data-table-search-input"
          placeholder="Search..."
          aria-label="Search table"
        />
      </div>
    )
  }

  <div class="data-table-wrapper">
    <table id={tableId} class="data-table" role="table">
      <thead>
        <tr>
          {
            columns.map((column) => (
              <th
                class:list={[
                  'data-table-header',
                  { 'data-table-header-sortable': column.sortable },
                ]}
                data-key={column.key}
                data-sortable={column.sortable}
                role="columnheader"
              >
                <button
                  class="data-table-header-button"
                  type="button"
                  disabled={!column.sortable}
                  aria-label={column.sortable ? `Sort by ${column.label}` : undefined}
                >
                  <span>{column.label}</span>
                  {column.sortable && (
                    <svg
                      class="data-table-sort-icon"
                      width="16"
                      height="16"
                      viewBox="0 0 16 16"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <path
                        d="M8 3L11 6H5L8 3Z"
                        class="sort-arrow sort-arrow-up"
                        fill="currentColor"
                      />
                      <path
                        d="M8 13L5 10H11L8 13Z"
                        class="sort-arrow sort-arrow-down"
                        fill="currentColor"
                      />
                    </svg>
                  )}
                </button>
              </th>
            ))
          }
          {
            actions.length > 0 && (
              <th class="data-table-header data-table-header-actions" role="columnheader">
                Actions
              </th>
            )
          }
        </tr>
      </thead>
      <tbody id={`${tableId}-body`}>
        {
          data.length === 0 ? (
            <tr>
              <td colspan={columns.length + (actions.length > 0 ? 1 : 0)} class="data-table-empty">
                <EmptyState
                  icon="inbox"
                  title={emptyMessage}
                  description="Try adjusting your search or filters"
                />
              </td>
            </tr>
          ) : (
            data.map((row) => (
              <tr class="data-table-row">
                {columns.map((column) => (
                  <td class="data-table-cell" data-label={column.label}>
                    <Fragment set:html={row[column.key]} />
                  </td>
                ))}
                {actions.length > 0 && (
                  <td class="data-table-cell data-table-cell-actions">
                    <div class="data-table-actions">
                      {actions.map((action) => (
                        <button
                          type="button"
                          class:list={[
                            'data-table-action-btn',
                            `data-table-action-btn-${action.variant || 'secondary'}`,
                          ]}
                          onclick={`${action.onClick}(${JSON.stringify(row)})`}
                        >
                          {action.label}
                        </button>
                      ))}
                    </div>
                  </td>
                )}
              </tr>
            ))
          )
        }
      </tbody>
    </table>
  </div>

  {
    data.length > itemsPerPage && (
      <div id={`${tableId}-pagination`} class="data-table-pagination">
        {/** Pagination will be rendered by client-side script */}
      </div>
    )
  }
</div>

<style>
  .data-table-container {
    width: 100%;
  }

  .data-table-search {
    margin-bottom: 1rem;
  }

  .data-table-search-input {
    width: 100%;
    max-width: 20rem;
    padding: 0.625rem 1rem;
    font-size: 0.875rem;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-md, 0.5rem);
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    transition:
      border-color 150ms ease,
      box-shadow 150ms ease;
  }

  .data-table-search-input:focus {
    outline: none;
    border-color: var(--color-primary, #6366f1);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary, #6366f1) 10%, transparent);
  }

  .data-table-wrapper {
    overflow-x: auto;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-md, 0.5rem);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .data-table thead {
    background: var(--color-background, #f9fafb);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .data-table-header {
    padding: 0;
    text-align: left;
    font-weight: 600;
    color: var(--color-text, #000);
    white-space: nowrap;
  }

  .data-table-header-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
    padding: 0.75rem 1rem;
    border: none;
    background: transparent;
    color: inherit;
    font: inherit;
    text-align: left;
    cursor: default;
  }

  .data-table-header-sortable .data-table-header-button {
    cursor: pointer;
    transition: background-color 150ms ease;
  }

  .data-table-header-sortable .data-table-header-button:hover {
    background: var(--color-surface, #fff);
  }

  .data-table-header-sortable .data-table-header-button:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: -2px;
  }

  .data-table-sort-icon {
    flex-shrink: 0;
    opacity: 0.3;
    transition: opacity 150ms ease;
  }

  .data-table-header-sortable:hover .data-table-sort-icon {
    opacity: 0.6;
  }

  .data-table-header[data-sort-direction] .data-table-sort-icon {
    opacity: 1;
  }

  .data-table-header[data-sort-direction='asc'] .sort-arrow-down,
  .data-table-header[data-sort-direction='desc'] .sort-arrow-up {
    opacity: 0.3;
  }

  .data-table-header-actions {
    text-align: right;
    padding: 0.75rem 1rem;
  }

  .data-table-row {
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    transition: background-color 150ms ease;
  }

  .data-table-row:last-child {
    border-bottom: none;
  }

  .data-table-row:hover {
    background: var(--color-background, #f9fafb);
  }

  .data-table-cell {
    padding: 1rem;
    color: var(--color-text, #000);
  }

  .data-table-cell-actions {
    text-align: right;
  }

  .data-table-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .data-table-action-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-sm, 0.375rem);
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    cursor: pointer;
    transition: all 150ms ease;
  }

  .data-table-action-btn:hover {
    background: var(--color-background, #f9fafb);
    border-color: var(--color-border, #d1d5db);
  }

  .data-table-action-btn:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  .data-table-action-btn-primary {
    background: #6366f1 !important;
    color: #ffffff !important;
    border-color: #6366f1 !important;
  }

  .data-table-action-btn-primary:hover {
    background: #4f46e5 !important;
    border-color: #4f46e5 !important;
    color: #ffffff !important;
  }

  .data-table-action-btn-danger {
    background: #ef4444 !important;
    color: #ffffff !important;
    border-color: #ef4444 !important;
  }

  .data-table-action-btn-danger:hover {
    background: #dc2626 !important;
    border-color: #dc2626 !important;
    color: #ffffff !important;
  }

  .data-table-empty {
    padding: 3rem 1rem;
    text-align: center;
  }

  .data-table-pagination {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  /* Responsive: Mobile */
  @media (max-width: 640px) {
    .data-table-search-input {
      max-width: 100%;
    }

    .data-table {
      font-size: 0.8125rem;
    }

    .data-table-header-button {
      padding: 0.625rem 0.75rem;
    }

    .data-table-cell {
      padding: 0.75rem;
    }

    .data-table-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .data-table-action-btn {
      width: 100%;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .data-table-search-input {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .data-table-wrapper {
      border-color: var(--color-border, #374151);
    }

    .data-table thead {
      background: var(--color-background, #111827);
      border-bottom-color: var(--color-border, #374151);
    }

    .data-table-row {
      border-bottom-color: var(--color-border, #374151);
    }

    .data-table-row:hover {
      background: var(--color-background, #111827);
    }

    .data-table-header-sortable .data-table-header-button:hover {
      background: var(--color-surface, #1f2937);
    }

    .data-table-action-btn {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .data-table-action-btn:hover {
      background: var(--color-background, #111827);
    }
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .data-table-search-input,
    .data-table-header-button,
    .data-table-sort-icon,
    .data-table-row,
    .data-table-action-btn {
      transition: none;
    }
  }
</style>

<script is:inline define:vars={{ tableId, itemsPerPage }}>
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  /**
   * DataTable Client-Side Functionality
   *
   * Manages:
   * - Column sorting
   * - Search/filter
   * - Pagination
   */

  /* eslint-disable no-redeclare */
  /* global tableId, itemsPerPage */

  function initDataTable() {
    const table = document.getElementById(tableId);
    const searchInput = document.getElementById(`${tableId}-search`);
    const tbody = document.getElementById(`${tableId}-body`);
    const paginationContainer = document.getElementById(`${tableId}-pagination`);

    if (!table || !tbody) return;

    let allRows = Array.from(tbody.querySelectorAll('.data-table-row'));
    let filteredRows = [...allRows];
    let currentPage = 1;
    let sortColumn = null;
    let sortDirection = null;

    // Search functionality
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();

        filteredRows = allRows.filter((row) => {
          const text = row.textContent.toLowerCase();
          return text.includes(searchTerm);
        });

        currentPage = 1;
        renderTable();
      });
    }

    // Sorting functionality
    const headers = table.querySelectorAll('.data-table-header-sortable');
    headers.forEach((header) => {
      const button = header.querySelector('.data-table-header-button');
      if (!button) return;

      button.addEventListener('click', () => {
        const key = header.dataset.key;

        // Toggle sort direction
        if (sortColumn === key) {
          sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          sortColumn = key;
          sortDirection = 'asc';
        }

        // Update header attributes
        headers.forEach((h) => h.removeAttribute('data-sort-direction'));
        header.setAttribute('data-sort-direction', sortDirection);

        // Sort rows
        const columnIndex = Array.from(header.parentElement.children).indexOf(header);
        filteredRows.sort((a, b) => {
          const aCell = a.children[columnIndex];
          const bCell = b.children[columnIndex];
          const aValue = aCell.textContent.trim();
          const bValue = bCell.textContent.trim();

          // Try numeric comparison first
          const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
          const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));

          if (!isNaN(aNum) && !isNaN(bNum)) {
            return sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
          }

          // Fall back to string comparison
          return sortDirection === 'asc'
            ? aValue.localeCompare(bValue)
            : bValue.localeCompare(aValue);
        });

        currentPage = 1;
        renderTable();
      });
    });

    // Pagination functionality
    function renderPagination() {
      if (!paginationContainer || filteredRows.length <= itemsPerPage) {
        if (paginationContainer) paginationContainer.innerHTML = '';
        return;
      }

      const totalPages = Math.ceil(filteredRows.length / itemsPerPage);

      let html = '<div class="pagination-controls">';

      // Previous button
      html += `<button 
        class="pagination-btn ${currentPage === 1 ? 'pagination-btn-disabled' : ''}"
        ${currentPage === 1 ? 'disabled' : ''}
        onclick="window.dataTableGoToPage('${tableId}', ${currentPage - 1})"
      >Previous</button>`;

      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        html += `<button 
          class="pagination-btn ${i === currentPage ? 'pagination-btn-active' : ''}"
          onclick="window.dataTableGoToPage('${tableId}', ${i})"
        >${i}</button>`;
      }

      // Next button
      html += `<button 
        class="pagination-btn ${currentPage === totalPages ? 'pagination-btn-disabled' : ''}"
        ${currentPage === totalPages ? 'disabled' : ''}
        onclick="window.dataTableGoToPage('${tableId}', ${currentPage + 1})"
      >Next</button>`;

      html += '</div>';
      paginationContainer.innerHTML = html;
    }

    // Render table with current page
    function renderTable() {
      // Clear tbody
      tbody.innerHTML = '';

      // Calculate pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageRows = filteredRows.slice(startIndex, endIndex);

      // Append rows
      if (pageRows.length === 0) {
        const emptyRow = document.createElement('tr');
        const emptyCell = document.createElement('td');
        emptyCell.colSpan = table.querySelectorAll('th').length;
        emptyCell.className = 'data-table-empty';
        emptyCell.innerHTML =
          '<div style="padding: 3rem 1rem; text-align: center; color: var(--color-text-muted);">No results found</div>';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
      } else {
        pageRows.forEach((row) => tbody.appendChild(row));
      }

      renderPagination();
    }

    // Global function for pagination
    window.dataTableGoToPage =
      window.dataTableGoToPage ||
      function (id, page) {
        if (id === tableId) {
          currentPage = page;
          renderTable();
        }
      };

    // Initial render
    renderTable();
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDataTable);
  } else {
    initDataTable();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initDataTable);
</script>

<style is:global>
  .pagination-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .pagination-btn {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-sm, 0.375rem);
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    cursor: pointer;
    transition: all 150ms ease;
  }

  .pagination-btn:hover:not(.pagination-btn-disabled) {
    background: var(--color-primary, #6366f1);
    color: white;
    border-color: var(--color-primary, #6366f1);
  }

  .pagination-btn-active {
    background: var(--color-primary, #6366f1);
    color: white;
    border-color: var(--color-primary, #6366f1);
  }

  .pagination-btn-disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination-btn:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  @media (prefers-color-scheme: dark) {
    .pagination-btn {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .pagination-btn:hover:not(.pagination-btn-disabled) {
      background: var(--color-primary, #6366f1);
      border-color: var(--color-primary, #6366f1);
    }
  }
</style>
