---
/**
 * Project Detail/Edit Page
 *
 * @description
 * Dashboard page for viewing and editing individual project details.
 * Includes form fields for project information, readonly metadata fields,
 * and a danger zone for project deletion.
 *
 * Features:
 * - Project edit form with validation styling
 * - Readonly fields for created/updated dates
 * - Save and cancel buttons
 * - Delete project button in danger zone
 * - Card-based layout for form sections
 * - Breadcrumb navigation
 */
import DashboardLayout from '@/layouts/DashboardLayout.astro';
import Card from '@dashboard-ui/Card.astro';
import Modal from '@dashboard-ui/Modal.astro';
import { getProject, getProjects, getTeamMembers } from '@/lib/dashboard-data';
import { Icon } from 'astro-icon/components';

// Generate static paths for all projects
export async function getStaticPaths() {
  const projects = getProjects();
  return projects.map((project) => ({
    params: { id: project.id },
  }));
}

// Get project ID from URL params
const { id } = Astro.params;

// Get project data
const project = id ? getProject(id) : undefined;

// If project not found, redirect to projects list
if (!project) {
  return Astro.redirect('/dashboard/projects');
}

// Get team members for owner dropdown
const teamMembers = getTeamMembers();

// Format date for display
function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    month: 'long',
    day: 'numeric',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

// Status options
const statusOptions = [
  { value: 'active', label: 'Active' },
  { value: 'draft', label: 'Draft' },
  { value: 'archived', label: 'Archived' },
];
---

<DashboardLayout
  title={`Edit ${project.name}`}
  description="Update project details"
  breadcrumbs={[
    { label: 'Dashboard', href: '/dashboard' },
    { label: 'Projects', href: '/dashboard/projects' },
    { label: project.name },
  ]}
>
  <div class="project-detail-page">
    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">{project.name}</h1>
        <p class="page-description">Update project information and settings</p>
      </div>
    </div>

    <!-- Project Information Form -->
    <form id="project-form" class="project-form">
      <Card title="Project Information" description="Basic details about your project">
        <div class="form-grid">
          <!-- Project Name -->
          <div class="form-group">
            <label for="project-name" class="form-label">
              Project Name <span class="form-required">*</span>
            </label>
            <input
              type="text"
              id="project-name"
              name="name"
              class="form-input"
              value={project.name}
              required
              aria-required="true"
            />
            <p class="form-help">A clear, descriptive name for your project</p>
          </div>

          <!-- Project Description -->
          <div class="form-group form-group-full">
            <label for="project-description" class="form-label">
              Description <span class="form-required">*</span>
            </label>
            <textarea
              id="project-description"
              name="description"
              class="form-textarea"
              rows="4"
              required
              aria-required="true">{project.description}</textarea
            >
            <p class="form-help">Provide a brief overview of the project goals and scope</p>
          </div>

          <!-- Status -->
          <div class="form-group">
            <label for="project-status" class="form-label">
              Status <span class="form-required">*</span>
            </label>
            <select
              id="project-status"
              name="status"
              class="form-select"
              required
              aria-required="true"
            >
              {
                statusOptions.map((option) => (
                  <option value={option.value} selected={project.status === option.value}>
                    {option.label}
                  </option>
                ))
              }
            </select>
            <p class="form-help">Current project status</p>
          </div>

          <!-- Owner -->
          <div class="form-group">
            <label for="project-owner" class="form-label">
              Owner <span class="form-required">*</span>
            </label>
            <select
              id="project-owner"
              name="owner"
              class="form-select"
              required
              aria-required="true"
            >
              {
                teamMembers.map((member) => (
                  <option value={member.name} selected={project.owner === member.name}>
                    {member.name}
                  </option>
                ))
              }
            </select>
            <p class="form-help">Team member responsible for this project</p>
          </div>
        </div>

        <div slot="footer">
          <a href="/dashboard/projects" class="btn btn-secondary"> Cancel </a>
          <button type="submit" class="btn btn-primary">
            <Icon name="lucide:save" />
            <span>Save Changes</span>
          </button>
        </div>
      </Card>

      <!-- Project Metadata -->
      <Card title="Project Metadata" description="Readonly information about this project">
        <div class="metadata-grid">
          <div class="metadata-item">
            <div class="metadata-label">Project ID</div>
            <div class="metadata-value">{project.id}</div>
          </div>

          <div class="metadata-item">
            <div class="metadata-label">Created</div>
            <div class="metadata-value">{formatDate(project.createdAt)}</div>
          </div>

          <div class="metadata-item">
            <div class="metadata-label">Last Updated</div>
            <div class="metadata-value">{formatDate(project.updatedAt)}</div>
          </div>
        </div>
      </Card>

      <!-- Danger Zone -->
      <Card title="Danger Zone" description="Irreversible actions">
        <div class="danger-zone">
          <div class="danger-zone-content">
            <h4 class="danger-zone-title">Delete Project</h4>
            <p class="danger-zone-description">
              Once you delete a project, there is no going back. Please be certain.
            </p>
          </div>
          <button type="button" id="delete-project-btn" class="btn btn-danger">
            <Icon name="lucide:trash-2" />
            <span>Delete Project</span>
          </button>
        </div>
      </Card>
    </form>
  </div>

  <!-- Delete Confirmation Modal -->
  <Modal id="delete-project-modal" title="Delete Project" size="sm">
    <div class="modal-content-wrapper">
      <div class="modal-icon-wrapper">
        <Icon name="lucide:alert-triangle" class="modal-icon" />
      </div>
      <p class="modal-message">
        Are you sure you want to delete <strong>{project.name}</strong>?
      </p>
      <p class="modal-warning">
        This action cannot be undone. All project data will be permanently deleted.
      </p>
    </div>

    <div slot="footer" class="modal-footer-actions">
      <button
        type="button"
        class="btn btn-secondary"
        onclick="window.closeModal('delete-project-modal')"
      >
        Cancel
      </button>
      <button type="button" id="confirm-delete-btn" class="btn btn-danger">
        <Icon name="lucide:trash-2" />
        <span>Delete Project</span>
      </button>
    </div>
  </Modal>
</DashboardLayout>

<style>
  .project-detail-page {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  /* Page Header */
  .page-header {
    margin-bottom: 0.5rem;
  }

  .page-header-content {
    flex: 1;
    min-width: 0;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text, #000);
    margin: 0 0 0.5rem 0;
    line-height: 1.2;
  }

  .page-description {
    font-size: 1rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  /* Form Styles */
  .project-form {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .form-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-group-full {
    grid-column: 1 / -1;
  }

  .form-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text, #000);
  }

  .form-required {
    color: var(--color-error, #ef4444);
  }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 0.625rem 1rem;
    font-size: 0.9375rem;
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-md, 0.5rem);
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    transition:
      border-color 150ms ease,
      box-shadow 150ms ease;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    outline: none;
    border-color: var(--color-primary, #6366f1);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-primary, #6366f1) 10%, transparent);
  }

  .form-input:invalid:not(:focus),
  .form-textarea:invalid:not(:focus),
  .form-select:invalid:not(:focus) {
    border-color: var(--color-error, #ef4444);
  }

  .form-textarea {
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
  }

  .form-help {
    font-size: 0.8125rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  /* Metadata Grid */
  .metadata-grid {
    display: grid;
    grid-template-columns: repeat(1, 1fr);
    gap: 1.5rem;
  }

  @media (min-width: 768px) {
    .metadata-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .metadata-item {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
  }

  .metadata-label {
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-muted, #6b7280);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .metadata-value {
    font-size: 0.9375rem;
    color: var(--color-text, #000);
    font-weight: 500;
  }

  /* Danger Zone */
  .danger-zone {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1.5rem;
    padding: 1.5rem;
    border: 1px solid var(--color-error, #ef4444);
    border-radius: var(--radius-md, 0.5rem);
    background: color-mix(in srgb, var(--color-error, #ef4444) 5%, transparent);
  }

  .danger-zone-content {
    flex: 1;
    min-width: 0;
  }

  .danger-zone-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text, #000);
    margin: 0 0 0.25rem 0;
  }

  .danger-zone-description {
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  /* Button Styles */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.9375rem;
    font-weight: 500;
    border-radius: var(--radius-md, 0.5rem);
    text-decoration: none;
    transition: all 150ms ease;
    cursor: pointer;
    border: none;
  }

  .btn :global(svg) {
    width: 1.125rem;
    height: 1.125rem;
  }

  .btn-primary {
    background: var(--color-primary, #6366f1);
    color: white;
  }

  .btn-primary:hover {
    background: color-mix(in srgb, var(--color-primary, #6366f1) 90%, black);
  }

  .btn-primary:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  .btn-secondary {
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    border: 1px solid var(--color-border, #e5e7eb);
  }

  .btn-secondary:hover {
    background: var(--color-background, #f9fafb);
  }

  .btn-secondary:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  .btn-danger {
    background: var(--color-error, #ef4444);
    color: white;
  }

  .btn-danger:hover {
    background: color-mix(in srgb, var(--color-error, #ef4444) 90%, black);
  }

  .btn-danger:focus-visible {
    outline: 2px solid var(--color-error, #ef4444);
    outline-offset: 2px;
  }

  /* Responsive adjustments */
  @media (max-width: 640px) {
    .page-title {
      font-size: 1.75rem;
    }

    .page-description {
      font-size: 0.9375rem;
    }

    .danger-zone {
      flex-direction: column;
      align-items: stretch;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .form-input,
    .form-textarea,
    .form-select {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .btn-secondary {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .btn-secondary:hover {
      background: var(--color-background, #111827);
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .form-input,
    .form-textarea,
    .form-select,
    .btn {
      transition: none;
    }
  }

  /* Modal Content Styles */
  .modal-content-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 1rem;
  }

  .modal-icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 50%;
    background: color-mix(in srgb, var(--color-error, #ef4444) 10%, transparent);
  }

  .modal-icon-wrapper :global(svg) {
    width: 2rem;
    height: 2rem;
    color: var(--color-error, #ef4444);
  }

  .modal-message {
    font-size: 1rem;
    color: var(--color-text, #000);
    margin: 0;
  }

  .modal-message strong {
    font-weight: 600;
  }

  .modal-warning {
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  .modal-footer-actions {
    display: flex;
    gap: 0.75rem;
    width: 100%;
  }

  .modal-footer-actions .btn {
    flex: 1;
  }
</style>

<script is:inline define:vars={{ projectId: project.id }}>
  /**
   * Project Form Handlers
   *
   * Handles form submission and project deletion.
   * In a real application, these would make API calls.
   */

  // Handle form submission
  const form = document.getElementById('project-form');
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      console.log('Saving project:', projectId, data);

      // In a real application, this would make an API call
      // For now, show success message and redirect
      if (window.showToast) {
        window.showToast({
          message: 'Project updated successfully',
          variant: 'success',
          duration: 3000,
        });
      } else {
        alert('Project updated successfully');
      }

      // Redirect back to projects list after a short delay
      setTimeout(() => {
        window.location.href = '/dashboard/projects';
      }, 1500);
    });
  }

  // Handle delete button - open modal instead of confirm dialog
  const deleteBtn = document.getElementById('delete-project-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', () => {
      // Open the delete confirmation modal
      window.openModal('delete-project-modal');
    });
  }

  // Handle confirm delete in modal
  const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
  if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', () => {
      console.log('Deleting project:', projectId);

      // Close the modal
      window.closeModal('delete-project-modal');

      // In a real application, this would make an API call
      if (window.showToast) {
        window.showToast({
          message: 'Project deleted successfully',
          variant: 'success',
          duration: 3000,
        });
      } else {
        alert('Project deleted successfully');
      }

      // Redirect to projects list after a short delay
      setTimeout(() => {
        window.location.href = '/dashboard/projects';
      }, 1500);
    });
  }

  // Form validation styling
  const inputs = form?.querySelectorAll('input, textarea, select');
  inputs?.forEach((input) => {
    input.addEventListener('blur', () => {
      const inputElement = input;
      if (!inputElement.validity.valid) {
        input.classList.add('invalid');
      } else {
        input.classList.remove('invalid');
      }
    });
  });
</script>
