---
/**
 * Billing Settings Page
 *
 * @description
 * Billing and subscription management page with plan information,
 * payment method, and billing history.
 */

import DashboardLayout from '@/layouts/DashboardLayout.astro';
import Card from '@dashboard-ui/Card.astro';
import { Icon } from 'astro-icon/components';
import { getBillingPlan, getPaymentMethod, getBillingHistory } from '@/lib/dashboard-data';

const breadcrumbs = [
  { label: 'Dashboard', href: '/dashboard' },
  { label: 'Settings', href: '/dashboard/settings' },
  { label: 'Billing' },
];

// Get billing data
const plan = getBillingPlan();
const paymentMethod = getPaymentMethod();
const billingHistory = getBillingHistory();

// Format next billing date
const nextBillingDate = plan.nextBillingDate.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Format payment method display
const paymentMethodDisplay =
  paymentMethod.type === 'card'
    ? `${paymentMethod.brand} •••• ${paymentMethod.last4}`
    : paymentMethod.type === 'paypal'
      ? 'PayPal'
      : 'Bank Account';
---

<DashboardLayout
  title="Billing Settings"
  description="Manage your subscription and billing information"
  breadcrumbs={breadcrumbs}
>
  <div class="billing-container">
    <div class="billing-header">
      <h1 class="billing-title">Billing & Subscription</h1>
      <p class="billing-description">
        Manage your subscription plan, payment method, and view billing history.
      </p>
    </div>

    <div class="billing-content">
      <!-- Current Plan Card -->
      <Card
        title="Current Plan"
        description="Your active subscription plan and features"
        padding="lg"
      >
        <div class="plan-details">
          <div class="plan-header">
            <div class="plan-info">
              <h3 class="plan-name">{plan.name}</h3>
              <div class="plan-price">
                <span class="plan-price-amount">${plan.price}</span>
                <span class="plan-price-interval">/{plan.interval}</span>
              </div>
            </div>
            <div class="plan-badge">
              <Icon name="lucide:check-circle" class="plan-badge-icon" />
              Active
            </div>
          </div>

          <div class="plan-billing-info">
            <div class="plan-billing-item">
              <Icon name="lucide:calendar" class="plan-billing-icon" />
              <span>Next billing date: <strong>{nextBillingDate}</strong></span>
            </div>
            <div class="plan-billing-item">
              <Icon name="lucide:credit-card" class="plan-billing-icon" />
              <span>Payment method: <strong>{paymentMethodDisplay}</strong></span>
            </div>
          </div>

          <div class="plan-features">
            <h4 class="plan-features-title">Plan Features</h4>
            <ul class="plan-features-list">
              {
                plan.features.map((feature) => (
                  <li class="plan-feature-item">
                    <Icon name="lucide:check" class="plan-feature-icon" />
                    <span>{feature}</span>
                  </li>
                ))
              }
            </ul>
          </div>
        </div>

        <div slot="footer">
          <button type="button" class="btn btn-ghost"> Cancel Subscription </button>
          <button type="button" class="btn btn-primary">
            <Icon name="lucide:arrow-up-circle" class="btn-icon" />
            Upgrade Plan
          </button>
        </div>
      </Card>

      <!-- Payment Method Card -->
      <Card title="Payment Method" description="Manage your payment information" padding="lg">
        <div class="payment-method">
          {
            paymentMethod.type === 'card' && (
              <div class="payment-card">
                <div class="payment-card-icon">
                  <Icon name="lucide:credit-card" />
                </div>
                <div class="payment-card-details">
                  <div class="payment-card-brand">{paymentMethod.brand}</div>
                  <div class="payment-card-number">•••• •••• •••• {paymentMethod.last4}</div>
                  <div class="payment-card-expiry">
                    Expires {paymentMethod.expiryMonth}/{paymentMethod.expiryYear}
                  </div>
                </div>
                <div class="payment-card-badge">
                  <Icon name="lucide:shield-check" class="payment-card-badge-icon" />
                  Verified
                </div>
              </div>
            )
          }

          <div class="payment-actions">
            <button type="button" class="btn btn-secondary">
              <Icon name="lucide:edit" class="btn-icon" />
              Update Payment Method
            </button>
          </div>
        </div>
      </Card>

      <!-- Billing History Card -->
      <Card title="Billing History" description="View your past invoices and payments" padding="lg">
        <div class="billing-history">
          <div class="billing-history-table">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Invoice</th>
                </tr>
              </thead>
              <tbody>
                {
                  billingHistory.map((item) => {
                    const formattedDate = item.date.toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric',
                    });

                    const statusColors = {
                      paid: 'status-badge-paid',
                      pending: 'status-badge-pending',
                      failed: 'status-badge-failed',
                    };

                    const statusLabels = {
                      paid: 'Paid',
                      pending: 'Pending',
                      failed: 'Failed',
                    };

                    return (
                      <tr>
                        <td>{formattedDate}</td>
                        <td>{item.description}</td>
                        <td class="amount-cell">${item.amount.toFixed(2)}</td>
                        <td>
                          <span class={`status-badge ${statusColors[item.status]}`}>
                            {statusLabels[item.status]}
                          </span>
                        </td>
                        <td>
                          {item.invoiceUrl && (
                            <a href={item.invoiceUrl} class="invoice-link">
                              <Icon name="lucide:download" class="invoice-icon" />
                              Download
                            </a>
                          )}
                        </td>
                      </tr>
                    );
                  })
                }
              </tbody>
            </table>
          </div>
        </div>
      </Card>

      <!-- Billing Information -->
      <div class="billing-info">
        <div class="billing-info-section">
          <h3 class="billing-info-title">
            <Icon name="lucide:help-circle" class="billing-info-icon" />
            Need Help?
          </h3>
          <p class="billing-info-text">
            If you have questions about your billing or need to make changes to your subscription,
            please contact our support team.
          </p>
          <button type="button" class="btn btn-secondary">
            <Icon name="lucide:mail" class="btn-icon" />
            Contact Support
          </button>
        </div>
      </div>
    </div>
  </div>
</DashboardLayout>

<style>
  .billing-container {
    max-width: 56rem;
    margin: 0 auto;
  }

  .billing-header {
    margin-bottom: 2rem;
  }

  .billing-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--color-text, #000);
    margin: 0 0 0.5rem 0;
  }

  .billing-description {
    font-size: 1rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  .billing-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Plan Details */
  .plan-details {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .plan-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .plan-info {
    flex: 1;
  }

  .plan-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-text, #000);
    margin: 0 0 0.5rem 0;
  }

  .plan-price {
    display: flex;
    align-items: baseline;
    gap: 0.25rem;
  }

  .plan-price-amount {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text, #000);
  }

  .plan-price-interval {
    font-size: 1rem;
    color: var(--color-text-muted, #6b7280);
  }

  .plan-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    font-weight: 600;
    background: color-mix(in srgb, var(--color-success, #10b981) 15%, transparent);
    color: var(--color-success, #10b981);
    border-radius: var(--radius-full, 9999px);
  }

  .plan-badge-icon {
    width: 1rem;
    height: 1rem;
  }

  .plan-billing-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .plan-billing-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text, #000);
  }

  .plan-billing-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-text-muted, #6b7280);
    flex-shrink: 0;
  }

  .plan-features {
    /* Container for features */
  }

  .plan-features-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text, #000);
    margin: 0 0 1rem 0;
  }

  .plan-features-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(15rem, 1fr));
    gap: 0.75rem;
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .plan-feature-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text, #000);
  }

  .plan-feature-icon {
    width: 1rem;
    height: 1rem;
    color: var(--color-success, #10b981);
    flex-shrink: 0;
  }

  /* Payment Method */
  .payment-method {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .payment-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: var(--color-background, #f9fafb);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-md, 0.5rem);
  }

  .payment-card-icon {
    width: 3rem;
    height: 3rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-surface, #fff);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-md, 0.5rem);
    color: var(--color-text-muted, #6b7280);
    flex-shrink: 0;
  }

  .payment-card-details {
    flex: 1;
  }

  .payment-card-brand {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--color-text, #000);
    margin-bottom: 0.25rem;
  }

  .payment-card-number {
    font-size: 1rem;
    color: var(--color-text, #000);
    margin-bottom: 0.25rem;
  }

  .payment-card-expiry {
    font-size: 0.8125rem;
    color: var(--color-text-muted, #6b7280);
  }

  .payment-card-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: color-mix(in srgb, var(--color-success, #10b981) 15%, transparent);
    color: var(--color-success, #10b981);
    border-radius: var(--radius-full, 9999px);
  }

  .payment-card-badge-icon {
    width: 0.875rem;
    height: 0.875rem;
  }

  .payment-actions {
    display: flex;
    gap: 0.75rem;
  }

  /* Billing History */
  .billing-history {
    overflow-x: auto;
  }

  .history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .history-table thead {
    background: var(--color-background, #f9fafb);
    border-bottom: 1px solid var(--color-border, #e5e7eb);
  }

  .history-table th {
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--color-text, #000);
    white-space: nowrap;
  }

  .history-table td {
    padding: 1rem;
    border-bottom: 1px solid var(--color-border, #e5e7eb);
    color: var(--color-text, #000);
  }

  .history-table tbody tr:last-child td {
    border-bottom: none;
  }

  .history-table tbody tr:hover {
    background: var(--color-background, #f9fafb);
  }

  .amount-cell {
    font-weight: 600;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: var(--radius-full, 9999px);
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .status-badge-paid {
    background: color-mix(in srgb, var(--color-success, #10b981) 15%, transparent);
    color: var(--color-success, #10b981);
  }

  .status-badge-pending {
    background: color-mix(in srgb, var(--color-warning, #f59e0b) 15%, transparent);
    color: var(--color-warning, #f59e0b);
  }

  .status-badge-failed {
    background: color-mix(in srgb, var(--color-error, #ef4444) 15%, transparent);
    color: var(--color-error, #ef4444);
  }

  .invoice-link {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-primary, #6366f1);
    text-decoration: none;
    transition: color 150ms ease;
  }

  .invoice-link:hover {
    color: color-mix(in srgb, var(--color-primary, #6366f1) 80%, black);
  }

  .invoice-icon {
    width: 1rem;
    height: 1rem;
  }

  /* Billing Info */
  .billing-info {
    padding: 1.5rem;
    background: var(--color-background, #f9fafb);
    border: 1px solid var(--color-border, #e5e7eb);
    border-radius: var(--radius-lg, 0.75rem);
  }

  .billing-info-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .billing-info-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text, #000);
    margin: 0;
  }

  .billing-info-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: var(--color-primary, #6366f1);
  }

  .billing-info-text {
    font-size: 0.875rem;
    color: var(--color-text-muted, #6b7280);
    margin: 0;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border: 1px solid transparent;
    border-radius: var(--radius-md, 0.5rem);
    cursor: pointer;
    transition: all 150ms ease;
    white-space: nowrap;
  }

  .btn:focus-visible {
    outline: 2px solid var(--color-primary, #6366f1);
    outline-offset: 2px;
  }

  .btn-icon {
    width: 1rem;
    height: 1rem;
  }

  .btn-primary {
    background: var(--color-primary, #6366f1);
    color: white;
    border-color: var(--color-primary, #6366f1);
  }

  .btn-primary:hover {
    background: color-mix(in srgb, var(--color-primary, #6366f1) 90%, black);
  }

  .btn-secondary {
    background: var(--color-surface, #fff);
    color: var(--color-text, #000);
    border-color: var(--color-border, #e5e7eb);
  }

  .btn-secondary:hover {
    background: var(--color-background, #f9fafb);
  }

  .btn-ghost {
    background: transparent;
    color: var(--color-text, #000);
    border-color: transparent;
  }

  .btn-ghost:hover {
    background: var(--color-background, #f9fafb);
  }

  /* Responsive */
  @media (max-width: 640px) {
    .billing-title {
      font-size: 1.5rem;
    }

    .plan-header {
      flex-direction: column;
    }

    .plan-features-list {
      grid-template-columns: 1fr;
    }

    .payment-card {
      flex-direction: column;
      align-items: flex-start;
    }

    .payment-actions {
      flex-direction: column;
      width: 100%;
    }

    .btn {
      width: 100%;
    }

    .history-table {
      font-size: 0.8125rem;
    }

    .history-table th,
    .history-table td {
      padding: 0.625rem 0.75rem;
    }
  }

  /* Dark mode */
  @media (prefers-color-scheme: dark) {
    .plan-header {
      border-bottom-color: var(--color-border, #374151);
    }

    .plan-badge {
      background: color-mix(in srgb, var(--color-success, #10b981) 25%, transparent);
    }

    .payment-card {
      background: var(--color-background, #111827);
      border-color: var(--color-border, #374151);
    }

    .payment-card-icon {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .payment-card-badge {
      background: color-mix(in srgb, var(--color-success, #10b981) 25%, transparent);
    }

    .history-table thead {
      background: var(--color-background, #111827);
      border-bottom-color: var(--color-border, #374151);
    }

    .history-table td {
      border-bottom-color: var(--color-border, #374151);
    }

    .history-table tbody tr:hover {
      background: var(--color-background, #111827);
    }

    .status-badge-paid {
      background: color-mix(in srgb, var(--color-success, #10b981) 25%, transparent);
    }

    .status-badge-pending {
      background: color-mix(in srgb, var(--color-warning, #f59e0b) 25%, transparent);
    }

    .status-badge-failed {
      background: color-mix(in srgb, var(--color-error, #ef4444) 25%, transparent);
    }

    .billing-info {
      background: var(--color-background, #111827);
      border-color: var(--color-border, #374151);
    }

    .btn-secondary {
      background: var(--color-surface, #1f2937);
      border-color: var(--color-border, #374151);
    }

    .btn-secondary:hover {
      background: var(--color-background, #111827);
    }

    .btn-ghost:hover {
      background: var(--color-background, #111827);
    }
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .btn,
    .invoice-link {
      transition: none;
    }
  }
</style>

<script>
  /**
   * Billing Settings Page Functionality
   */

  function initBillingSettings() {
    // Add event listeners for upgrade/manage buttons if needed
    const upgradeBtn = document.querySelector('.btn-primary');
    const manageBtn = document.querySelector('.btn-secondary');

    if (upgradeBtn) {
      upgradeBtn.addEventListener('click', () => {
        if (window.showToast) {
          window.showToast({
            message: 'Upgrade functionality would redirect to payment page',
            variant: 'info',
            duration: 3000,
          });
        }
      });
    }

    if (manageBtn) {
      manageBtn.addEventListener('click', () => {
        if (window.showToast) {
          window.showToast({
            message: 'Payment method management would open here',
            variant: 'info',
            duration: 3000,
          });
        }
      });
    }
  }

  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initBillingSettings);
  } else {
    initBillingSettings();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', initBillingSettings);
</script>
