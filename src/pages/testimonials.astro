---
import MarketingLayout from '@/layouts/MarketingLayout.astro';
import PageHeader from '@sections/content/PageHeader.astro';
import TestimonialsGrid from '@sections/social-proof/TestimonialsGrid.astro';
import CTA from '@sections/marketing/CTA.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig } from '@/config';

type TestimonialEntry = CollectionEntry<'testimonials'>;

const testimonials = await getCollection(
  'testimonials',
  ({ data }: { data: TestimonialEntry['data'] }) => !data.draft
);
const sortedTestimonials = testimonials.sort(
  (a: TestimonialEntry, b: TestimonialEntry) => a.data.order - b.data.order
);

// Separate featured testimonials for highlight section
const featuredTestimonials = sortedTestimonials.filter((t: TestimonialEntry) => t.data.featured);
const otherTestimonials = sortedTestimonials.filter((t: TestimonialEntry) => !t.data.featured);
---

<MarketingLayout
  title={`Testimonials - ${siteConfig.name}`}
  description={`See what developers and teams are saying about ${siteConfig.name}. Real stories from real users.`}
>
  <PageHeader
    title="Loved by developers"
    subtitle={`Don't just take our word for it. Here's what developers and teams are saying about ${siteConfig.name}.`}
  />

  <TestimonialsGrid
    featured={featuredTestimonials.map((t: TestimonialEntry) => ({
      quote: t.data.quote,
      author: t.data.author,
      role: t.data.role,
      company: t.data.company,
      avatar: t.data.avatar,
    }))}
    testimonials={otherTestimonials.map((t: TestimonialEntry) => ({
      quote: t.data.quote,
      author: t.data.author,
      role: t.data.role,
      company: t.data.company,
      avatar: t.data.avatar,
    }))}
    emptyMessage="No testimonials yet. Check back soon!"
    background="default"
  />

  <CTA
    title="Ready to join them?"
    description="Start building and shipping faster with our modern deployment platform."
    action={{ label: 'Get Started Free', href: '/pricing' }}
    background="muted"
  />
</MarketingLayout>
